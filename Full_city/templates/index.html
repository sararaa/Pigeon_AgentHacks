<!DOCTYPE html>
<html>
  <head>
    <title>Traffic Predictor Map</title>
    <style>
      #map      { height: 80vh; width: 100%; }
      #controls { padding: 0.5em; }
    </style>
    <script
      src="https://maps.googleapis.com/maps/api/js?key={{AIzaSyAoH0FX8uQBoOHRIUnghIJBQUaNF-Bw-uQ}}&callback=initMap"
      async defer
    ></script>
  </head>
  <body>
    <div id="controls">
      <input type="datetime-local" id="timeInput" />
      <button onclick="updatePredictions()">Show Predictions</button>
    </div>
    <div id="map"></div>

    <script>
      let map, markers = [];
      const roadCoords = {{ road_coords|tojson }};

      function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: 37.7749, lng: -122.4194 },
          zoom: 13
        });
        new google.maps.TrafficLayer().setMap(map);
      }

      function updatePredictions() {
        const ts = document.getElementById("timeInput").value;
        if (!ts) return alert("Pick a datetime first");
        fetch(`/predict_all?timestamp=${encodeURIComponent(ts)}`)
          .then(r => r.json())
          .then(data => {
            markers.forEach(m => m.setMap(null));
            markers = [];

            data.forEach(({ road, level }) => {
              const coord = roadCoords[road];
              if (!coord) return;
              const colors = {1:"green",2:"orange",3:"red",4:"darkred"};
              const circle = new google.maps.Circle({
                map,
                center: { lat: coord[0], lng: coord[1] },
                radius: 80,
                strokeColor: colors[level],
                strokeWeight: 2,
                fillColor:   colors[level],
                fillOpacity: 0.4
              });
              markers.push(circle);
            });
          })
          .catch(console.error);
      }
    </script>
  </body>
</html>
